# DC Power Meter

This is the Zephyr sensor app on the Arduino 101 to measure DC power of the
smart house. It uses two TI INA219 current sensor boards from Adafruit to
measure the DC power consumption of the house, and the power generated by
the solar panel.

## Required HW
* TI INA 219 current sensor board: https://www.adafruit.com/products/904

Please note that the pins A0 and A1 to diffrentiate up to 4 boards. For this DC power meter, we will use 2 boards addressed by channel 0 (A0 and A1 are opened) and 1 (A0 closed, A1 opened. Short the pin A0 on one board to make it address 1.

* Grove RGB Backlight LCD: https://www.seeedstudio.com/Grove-LCD-RGB-Backlight-p-1643.html

The power values will be displayed on a Grove RGB LCD display (optional). Please
note that the display works at 5V and requires a pull-up circuit to function. 

* USB FTDI cable: http://www.ftdichip.com/Products/Cables/USBTTLSerial.htm

The values are also transferred to the home gateway via UART line. A USB FTDI
should be used to connect from the Arduino 101 board to the gateway.

The pins should be connected like this:
```
    Arduino 101	|	USB FTDI cable
        RX		|	    TX
        TX		|	    RX
        GND		|	    GND
```

## Data format and flow
In general, the DC power meter measure power consumption and energy generated by the solar panel in two channels. It sends those data over BLE or serial connection via USB FTDI to the home gateway. The home gateway, in turn, receives the data and uses an OCF resource to expose the data to other devices and the cloud.

In case of BLE connection, the DC power meter uses a custom service with two characteristics: consumption and solar to notify the values to the home gateway.
 
In case of serial connection, it uses the JSON format to send data messages to the home gateway. The messages will look like:
```
    {"ch-1":1000, "ch-2":500}
```

The gateway uses a node script "power-uart.js" to receives data from the DC power meter and creates the OCF resource to manipulate the data. Use the following command to run the script:
```
    # node <SmartHome-Demo folder>/ocf-servers/js-servers/power-uart.js
```
Please note that the gateway will need BLE capability to connect to the sensor. It also needs "noble" module to work. The noble can be installed by the following command in the SmartHome-Demo location.
```
    # npm install noble
```

## How to build and flash the app
In order to build the Zephyr app for the Arduino 101 board, first setup the Zephyr dev environment following the guidance here.
* https://wiki.zephyrproject.org/view/Arduino_101

In the app source folder, use the following commands to build and flash the sensor app to Arduino 101 board:
```
    $ make pristine && make BOARD=arduino_101_sss ARCH=arc
    $ sudo -E dfu-util -a sensor_core -D outdir/arduino_101_sss/zephyr.bin
```
Use the following commands to build and flash the BLE app to the Arduino 101 board:
```
    $ make BOARD=arduino_101 ARCH=x86
    $ sudo -E dfu-util -a x86_app -D outdir/arduino_101/zephyr.bin
```

## Supported Zephyr versions:
The code has been verified to work with Zephyr v1.6.0
